<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Budget Tracker</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    
    <!-- iOS PWA Meta Tags -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Budget Tracker">
    <meta name="theme-color" content="#1f2937">
    
    <!-- App Icons -->
    <link rel="apple-touch-icon" sizes="180x180" href="https://github.com/Kakyyn/budget/blob/9164ab16aff04ed729280e020d76c1cd4921482b/favicon-32x32.png">
    <link rel="apple-touch-icon" sizes="152x152" href="https://github.com/Kakyyn/budget/blob/9164ab16aff04ed729280e020d76c1cd4921482b/favicon-32x32.png">
    <link rel="apple-touch-icon" sizes="144x144" href="https://github.com/Kakyyn/budget/blob/9164ab16aff04ed729280e020d76c1cd4921482b/favicon-32x32.png">
    <link rel="apple-touch-icon" sizes="120x120" href="https://github.com/Kakyyn/budget/blob/9164ab16aff04ed729280e020d76c1cd4921482b/favicon-32x32.png">
    <link rel="apple-touch-icon" sizes="114x114" href="https://github.com/Kakyyn/budget/blob/9164ab16aff04ed729280e020d76c1cd4921482b/favicon-32x32.png">
    <link rel="apple-touch-icon" sizes="76x76" href="https://github.com/Kakyyn/budget/blob/9164ab16aff04ed729280e020d76c1cd4921482b/favicon-32x32.png">
    <link rel="apple-touch-icon" sizes="72x72" href="https://github.com/Kakyyn/budget/blob/9164ab16aff04ed729280e020d76c1cd4921482b/favicon-32x32.png">
    <link rel="apple-touch-icon" sizes="60x60" href="https://github.com/Kakyyn/budget/blob/9164ab16aff04ed729280e020d76c1cd4921482b/favicon-32x32.png">
    <link rel="apple-touch-icon" sizes="57x57" href="https://github.com/Kakyyn/budget/blob/9164ab16aff04ed729280e020d76c1cd4921482b/favicon-32x32.png">

    <!-- Web App Manifest -->
    <link rel="manifest" id="app-manifest">
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        
        * {
            font-family: 'Inter', sans-serif;
            -webkit-tap-highlight-color: transparent;
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            user-select: none;
        }
        
        input, textarea, select {
            -webkit-user-select: text;
            user-select: text;
        }
        
        body {
            padding-top: env(safe-area-inset-top);
            padding-bottom: env(safe-area-inset-bottom);
            padding-left: env(safe-area-inset-left);
            padding-right: env(safe-area-inset-right);
            overscroll-behavior: none;
            background: #111827;
            color: #f9fafb;
        }
        
        .notion-card {
            background: #1f2937;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            border: 1px solid #374151;
        }
        
        .notion-button {
            background: #3b82f6;
            color: white;
            border: none;
            border-radius: 8px;
            padding: 12px 16px;
            font-weight: 600;
            transition: all 0.2s;
            touch-action: manipulation;
        }
        
        .notion-button:hover, .notion-button:focus {
            background: #2563eb;
            transform: translateY(-1px);
        }
        
        .notion-button:active {
            transform: translateY(0);
        }
        
        .progress-bar {
            background: linear-gradient(90deg, #10b981, #059669);
            border-radius: 6px;
            height: 8px;
            transition: width 0.3s ease;
        }
        
        .debt-progress-bar {
            background: linear-gradient(90deg, #f59e0b, #d97706);
            border-radius: 6px;
            height: 8px;
            transition: width 0.3s ease;
        }
        
        .expense-item:hover, .income-item:hover, .debt-item:hover, .savings-item:hover {
            background: #374151;
            transform: translateY(-1px);
            transition: all 0.2s;
        }
        
        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .income-card {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        }
        
        .expense-card {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
        }
        
        .debt-card {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
        }
        
        .savings-card {
            background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);
        }
        
        .chart-container {
            position: relative;
            height: 280px;
            margin: 20px 0;
        }
        
        .chart-container canvas {
            max-height: 280px !important;
        }
        
        .fade-in {
            animation: fadeIn 0.3s ease-in;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .settings-toggle {
            background: #374151;
            border-radius: 8px;
            padding: 2px;
            display: flex;
            gap: 2px;
        }
        
        .settings-toggle button {
            padding: 8px 12px;
            border-radius: 6px;
            font-weight: 500;
            transition: all 0.2s;
            border: none;
            background: transparent;
            color: #9ca3af;
            font-size: 0.875rem;
        }
        
        .settings-toggle button.active {
            background: #1f2937;
            color: #f9fafb;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.3);
        }
        
        .currency-badge {
            background: #374151;
            color: #d1d5db;
            padding: 4px 8px;
            border-radius: 6px;
            font-size: 0.75rem;
            font-weight: 600;
        }
        
        .settings-panel {
            position: absolute;
            top: 100%;
            right: 0;
            background: #1f2937;
            border: 1px solid #374151;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            padding: 20px;
            min-width: 280px;
            z-index: 1000;
        }
        
        .mobile-header {
            position: sticky;
            top: 0;
            background: rgba(17, 24, 39, 0.95);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            z-index: 100;
            border-bottom: 1px solid #374151;
        }
        
        .mobile-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: #111827;
            z-index: 9999;
            display: flex;
            flex-direction: column;
            transform: translateY(100%);
            transition: transform 0.3s ease;
        }
        
        .mobile-modal.show {
            transform: translateY(0);
        }
        
        .mobile-modal-header {
            padding: 16px 20px;
            border-bottom: 1px solid #374151;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: #1f2937;
        }
        
        .mobile-modal-content {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
        }
        
        .touch-target {
            min-height: 44px;
            min-width: 44px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .quick-action-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
        }
        
        @media (min-width: 640sm) {
            .quick-action-grid {
                grid-template-columns: repeat(4, 1fr);
            }
        }
        
        .action-button {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 20px 16px;
            border-radius: 12px;
            font-weight: 600;
            transition: all 0.2s;
            text-align: center;
            min-height: 100px;
        }
        
        .action-button i {
            font-size: 24px;
        }
        
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(17, 24, 39, 0.95);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-top: 1px solid #374151;
            padding: 8px 0;
            padding-bottom: env(safe-area-inset-bottom, 8px);
            z-index: 100;
        }
        
        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 8px 12px;
            border-radius: 8px;
            transition: all 0.2s;
            color: #9ca3af;
            font-size: 12px;
            font-weight: 500;
        }
        
        .nav-item.active {
            color: #3b82f6;
            background: rgba(59, 130, 246, 0.1);
        }
        
        .nav-item i {
            font-size: 20px;
            margin-bottom: 4px;
        }
        
        .content-with-nav {
            padding-bottom: 80px;
        }
        
        .install-prompt {
            position: fixed;
            bottom: 90px;
            left: 16px;
            right: 16px;
            background: #3b82f6;
            color: white;
            padding: 16px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            box-shadow: 0 4px 20px rgba(59, 130, 246, 0.3);
            transform: translateY(200px);
            transition: transform 0.3s ease;
            z-index: 1000;
        }
        
        .install-prompt.show {
            transform: translateY(0);
        }
        
        input, select, textarea {
            background: #374151 !important;
            border-color: #4b5563 !important;
            color: #f9fafb !important;
        }
        
        input:focus, select:focus, textarea:focus {
            border-color: #3b82f6 !important;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1) !important;
        }
        
        .month-filter {
            background: #374151;
            border-radius: 8px;
            padding: 4px;
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 16px;
        }
        
        .month-filter select {
            background: #1f2937 !important;
            border: 1px solid #4b5563 !important;
            border-radius: 6px !important;
            padding: 8px 12px !important;
            color: #f9fafb !important;
            font-size: 14px;
        }
        
        .month-filter label {
            color: #d1d5db;
            font-size: 14px;
            font-weight: 500;
        }
        
        @media (display-mode: standalone) {
            .install-prompt {
                display: none;
            }
        }
        
        .empty-state {
            color: #6b7280;
        }
        
        .empty-state i {
            color: #4b5563;
        }
        
        h1, h2, h3, h4 {
            color: #f9fafb;
        }
        
        .text-gray-900 {
            color: #f9fafb !important;
        }
        
        .text-gray-500 {
            color: #9ca3af !important;
        }
        
        .text-gray-700 {
            color: #d1d5db !important;
        }
        
        .border-gray-200 {
            border-color: #374151 !important;
        }
        
        .border-gray-300 {
            border-color: #4b5563 !important;
        }
        
        .bg-gray-50 {
            background: #111827 !important;
        }
        
        .hover\:bg-gray-50:hover {
            background: #374151 !important;
        }
        
        .hover\:bg-gray-100:hover {
            background: #374151 !important;
        }
        
        .bg-gray-100 {
            background: #374151 !important;
        }
        
        .debt-summary-card {
            background: #2d3748;
            border: 1px solid #4a5568;
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 16px;
        }
        
        .contribution-button {
            background: #48bb78;
            color: white;
            border: none;
            border-radius: 6px;
            padding: 6px 12px;
            font-size: 0.875rem;
            font-weight: 500;
            transition: all 0.2s;
            touch-action: manipulation;
        }
        
        .contribution-button:hover {
            background: #38a169;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .type-list {
            max-height: 300px;
            overflow-y: auto;
        }
        
        .type-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            border: 1px solid #4b5563;
            border-radius: 8px;
            margin-bottom: 8px;
            background: #374151;
        }
        
        .add-type-form {
            display: flex;
            gap: 8px;
            margin-bottom: 16px;
        }
        
        .secondary-amount {
            font-size: 0.75rem;
            color: #9ca3af;
            margin-top: 2px;
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <!-- Mobile Header -->
    <header class="mobile-header">
        <div class="px-4 py-3">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-3">
                    <div class="w-10 h-10 bg-blue-600 rounded-xl flex items-center justify-center">
                        <i class="fas fa-wallet text-white text-lg"></i>
                    </div>
                    <h1 class="text-xl font-bold text-gray-900" data-translate="title">Budget Tracker</h1>
                </div>
                <div class="flex items-center space-x-2">
                    <!-- Settings -->
                    <div class="relative">
                        <button onclick="toggleSettings()" class="touch-target text-gray-500 hover:text-gray-300 rounded-lg hover:bg-gray-100">
                            <i class="fas fa-cog text-lg"></i>
                        </button>
                        <div id="settingsPanel" class="settings-panel hidden">
                            <h3 class="text-lg font-semibold text-gray-900 mb-4" data-translate="settings">Settings</h3>
                            
                            <div class="mb-4">
                                <label class="block text-sm font-medium text-gray-700 mb-2" data-translate="language">Language</label>
                                <div class="settings-toggle">
                                    <button onclick="changeLanguage('en')" id="langEn" class="active">English</button>
                                    <button onclick="changeLanguage('es')" id="langEs">Español</button>
                                </div>
                            </div>
                            
                            <div class="mb-4">
                                <label class="block text-sm font-medium text-gray-700 mb-2" data-translate="baseCurrency">Base Currency</label>
                                <div class="settings-toggle">
                                    <button onclick="changeBaseCurrency('USD')" id="currUSD" class="active">USD</button>
                                    <button onclick="changeBaseCurrency('CRC')" id="currCRC">CRC</button>
                                </div>
                            </div>
                            
                            <div class="mb-4">
                                <label class="block text-sm font-medium text-gray-700 mb-2" data-translate="exchangeRate">Exchange Rate (USD to CRC)</label>
                                <input type="number" id="exchangeRate" value="520" step="0.01" 
                                       class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500"
                                       onchange="updateExchangeRate()">
                                <p class="text-xs text-gray-500 mt-1" data-translate="exchangeRateHelp">1 USD = X CRC</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <div class="content-with-nav">
        <div class="px-4 py-6">
            <!-- Month Filter -->
            <div class="notion-card p-4 mb-6">
                <div class="month-filter">
                    <label data-translate="filterByMonth">Filter by Month:</label>
                    <select id="monthFilter" onchange="filterByMonth()">
                        <option value="all" data-translate="allMonths">All Months</option>
                    </select>
                    <button onclick="clearFilter()" class="text-sm text-blue-400 hover:text-blue-300 ml-2" data-translate="clearFilter">Clear</button>
                </div>
            </div>

            <!-- Dashboard Overview -->
            <div class="grid grid-cols-2 gap-4 mb-6">
                <!-- Total Balance Card -->
                <div class="notion-card stat-card p-4">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-white/80 text-xs font-medium" data-translate="totalBalance">Total Balance</p>
                            <p class="text-lg font-bold text-white" id="totalBalance">$0.00</p>
                            <p class="text-xs text-white/60" id="totalBalanceSecondary"></p>
                        </div>
                        <i class="fas fa-chart-line text-white/60 text-xl"></i>
                    </div>
                </div>

                <!-- Income Card -->
                <div class="notion-card income-card p-4">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-white/80 text-xs font-medium" data-translate="income">Income</p>
                            <p class="text-lg font-bold text-white" id="totalIncome">$0.00</p>
                            <p class="text-xs text-white/60" id="totalIncomeSecondary"></p>
                        </div>
                        <i class="fas fa-arrow-up text-white/60 text-xl"></i>
                    </div>
                </div>

                <!-- Expenses Card -->
                <div class="notion-card expense-card p-4">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-white/80 text-xs font-medium" data-translate="expenses">Expenses</p>
                            <p class="text-lg font-bold text-white" id="totalExpenses">$0.00</p>
                            <p class="text-xs text-white/60" id="totalExpensesSecondary"></p>
                        </div>
                        <i class="fas fa-arrow-down text-white/60 text-xl"></i>
                    </div>
                </div>

                <!-- Debt Card -->
                <div class="notion-card debt-card p-4">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-white/80 text-xs font-medium" data-translate="totalDebt">Total Debt</p>
                            <p class="text-lg font-bold text-white" id="totalDebt">$0.00</p>
                            <p class="text-xs text-white/60" id="totalDebtSecondary"></p>
                        </div>
                        <i class="fas fa-credit-card text-white/60 text-xl"></i>
                    </div>
                </div>
            </div>

            <!-- Quick Actions -->
            <div class="notion-card p-4 mb-6">
                <h2 class="text-lg font-semibold text-gray-900 mb-4" data-translate="quickActions">Quick Actions</h2>
                <div class="quick-action-grid">
                    <button onclick="openModal('income')" class="action-button bg-green-600 hover:bg-green-700 text-white">
                        <i class="fas fa-plus"></i>
                        <span data-translate="addIncome">Add Income</span>
                    </button>
                    <button onclick="openModal('expense')" class="action-button bg-red-600 hover:bg-red-700 text-white">
                        <i class="fas fa-minus"></i>
                        <span data-translate="addExpense">Add Expense</span>
                    </button>
                    <button onclick="openModal('debt')" class="action-button bg-yellow-600 hover:bg-yellow-700 text-white">
                        <i class="fas fa-credit-card"></i>
                        <span data-translate="addDebt">Add Debt</span>
                    </button>
                    <button onclick="openModal('savings')" class="action-button bg-purple-600 hover:bg-purple-700 text-white">
                        <i class="fas fa-coins"></i>
                        <span data-translate="addSavings">Add Savings</span>
                    </button>
                </div>
            </div>

            <!-- List View Content -->
            <div id="listView" class="fade-in">
                <div class="space-y-6">
                    <!-- Income Section -->
                    <div class="notion-card">
                        <div class="p-4 border-b border-gray-200">
                            <div class="flex items-center justify-between">
                                <h3 class="text-lg font-semibold text-gray-900 flex items-center">
                                    <i class="fas fa-arrow-up text-green-500 mr-2"></i>
                                    <span data-translate="recentIncome">Recent Income</span>
                                </h3>
                                <button onclick="openModal('income')" class="text-blue-400 hover:text-blue-300 text-sm font-medium touch-target">
                                    + <span data-translate="addIncome">Add Income</span>
                                </button>
                            </div>
                        </div>
                        <div class="p-4">
                            <div id="incomeList" class="space-y-3 max-h-64 overflow-y-auto">
                                <div class="text-center empty-state py-8">
                                    <i class="fas fa-wallet text-4xl mb-3"></i>
                                    <p data-translate="noIncomeEntries">No income entries yet</p>
                                    <p class="text-sm" data-translate="addFirstIncome">Add your first income source</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Expenses Section -->
                    <div class="notion-card">
                        <div class="p-4 border-b border-gray-200">
                            <div class="flex items-center justify-between">
                                <h3 class="text-lg font-semibold text-gray-900 flex items-center">
                                    <i class="fas fa-arrow-down text-red-500 mr-2"></i>
                                    <span data-translate="recentExpenses">Recent Expenses</span>
                                </h3>
                                <button onclick="openModal('expense')" class="text-blue-400 hover:text-blue-300 text-sm font-medium touch-target">
                                    + <span data-translate="addExpense">Add Expense</span>
                                </button>
                            </div>
                        </div>
                        <div class="p-4">
                            <div id="expensesList" class="space-y-3 max-h-64 overflow-y-auto">
                                <div class="text-center empty-state py-8">
                                    <i class="fas fa-shopping-cart text-4xl mb-3"></i>
                                    <p data-translate="noExpensesRecorded">No expenses recorded</p>
                                    <p class="text-sm" data-translate="trackSpending">Track your spending</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Debt Section -->
                    <div class="notion-card">
                        <div class="p-4 border-b border-gray-200">
                            <div class="flex items-center justify-between">
                                <h3 class="text-lg font-semibold text-gray-900 flex items-center">
                                    <i class="fas fa-credit-card text-yellow-500 mr-2"></i>
                                    <span data-translate="debtTracking">Debt Tracking</span>
                                </h3>
                                <button onclick="openModal('debt')" class="text-blue-400 hover:text-blue-300 text-sm font-medium touch-target">
                                    + <span data-translate="addDebt">Add Debt</span>
                                </button>
                            </div>
                        </div>
                        <div class="p-4">
                            <!-- Debt Summary by Category -->
                            <div id="debtSummary" class="mb-4"></div>
                            
                            <div id="debtList" class="space-y-4 max-h-64 overflow-y-auto">
                                <div class="text-center empty-state py-8">
                                    <i class="fas fa-handshake text-4xl mb-3"></i>
                                    <p data-translate="noDebtsTracked">No debts tracked</p>
                                    <p class="text-sm" data-translate="monitorDebts">Monitor your debts</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Savings Section -->
                    <div class="notion-card">
                        <div class="p-4 border-b border-gray-200">
                            <div class="flex items-center justify-between">
                                <h3 class="text-lg font-semibold text-gray-900 flex items-center">
                                    <i class="fas fa-piggy-bank text-purple-500 mr-2"></i>
                                    <span data-translate="savingsGoals">Savings Goals</span>
                                </h3>
                                <button onclick="openModal('savings')" class="text-blue-400 hover:text-blue-300 text-sm font-medium touch-target">
                                    + <span data-translate="addSavings">Add Savings</span>
                                </button>
                            </div>
                        </div>
                        <div class="p-4">
                            <div id="savingsList" class="space-y-4 max-h-64 overflow-y-auto">
                                <div class="text-center empty-state py-8">
                                    <i class="fas fa-target text-4xl mb-3"></i>
                                    <p data-translate="noSavingsGoals">No savings goals set</p>
                                    <p class="text-sm" data-translate="startSaving">Start saving for your goals</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Graph View Content -->
            <div id="graphView" class="hidden fade-in">
                <div class="space-y-6">
                    <!-- Income vs Expenses Chart -->
                    <div class="notion-card p-4">
                        <h3 class="text-lg font-semibold text-gray-900 mb-4 flex items-center">
                            <i class="fas fa-chart-line text-blue-500 mr-2"></i>
                            <span data-translate="incomeExpensesTrend">Income vs Expenses Trend</span>
                        </h3>
                        <div class="chart-container">
                            <canvas id="incomeExpenseChart"></canvas>
                        </div>
                    </div>

                    <!-- Expense Categories Pie Chart -->
                    <div class="notion-card p-4">
                        <h3 class="text-lg font-semibold text-gray-900 mb-4 flex items-center">
                            <i class="fas fa-chart-pie text-red-500 mr-2"></i>
                            <span data-translate="expenseCategories">Expense Categories</span>
                        </h3>
                        <div class="chart-container">
                            <canvas id="expenseCategoryChart"></canvas>
                        </div>
                    </div>

                    <!-- Monthly Totals Bar Chart -->
                    <div class="notion-card p-4">
                        <h3 class="text-lg font-semibold text-gray-900 mb-4 flex items-center">
                            <i class="fas fa-chart-bar text-green-500 mr-2"></i>
                            <span data-translate="monthlyTotals">Monthly Totals</span>
                        </h3>
                        <div class="chart-container">
                            <canvas id="monthlyTotalsChart"></canvas>
                        </div>
                    </div>

                    <!-- Debt Progress Chart -->
                    <div class="notion-card p-4">
                        <h3 class="text-lg font-semibold text-gray-900 mb-4 flex items-center">
                            <i class="fas fa-chart-bar text-yellow-500 mr-2"></i>
                            <span data-translate="debtProgress">Debt Progress</span>
                        </h3>
                        <div class="chart-container">
                            <canvas id="debtProgressChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Types Management View -->
            <div id="typesView" class="hidden fade-in">
                <div class="space-y-6">
                    <!-- Category Types Management -->
                    <div class="notion-card p-4">
                        <h3 class="text-lg font-semibold text-gray-900 mb-4 flex items-center">
                            <i class="fas fa-tags text-blue-500 mr-2"></i>
                            <span data-translate="manageCategories">Manage Categories</span>
                        </h3>
                        
                        <!-- Category Type Tabs -->
                        <div class="settings-toggle mb-4">
                            <button onclick="switchCategoryTab('income')" id="tabIncome" class="active">Income</button>
                            <button onclick="switchCategoryTab('expense')" id="tabExpense">Expenses</button>
                            <button onclick="switchCategoryTab('debt')" id="tabDebt">Debt</button>
                            <button onclick="switchCategoryTab('savings')" id="tabSavings">Savings</button>
                        </div>

                        <!-- Income Categories -->
                        <div id="incomeCategories" class="tab-content active">
                            <div class="add-type-form">
                                <input type="text" id="newIncomeCategory" placeholder="New income category" class="flex-1 border border-gray-300 rounded-lg px-3 py-2">
                                <button onclick="addCategory('income')" class="notion-button">Add</button>
                            </div>
                            <div id="incomeCategoryList" class="type-list"></div>
                        </div>

                        <!-- Expense Categories -->
                        <div id="expenseCategories" class="tab-content">
                            <div class="add-type-form">
                                <input type="text" id="newExpenseCategory" placeholder="New expense category" class="flex-1 border border-gray-300 rounded-lg px-3 py-2">
                                <button onclick="addCategory('expense')" class="notion-button">Add</button>
                            </div>
                            <div id="expenseCategoryList" class="type-list"></div>
                        </div>

                        <!-- Debt Categories -->
                        <div id="debtCategories" class="tab-content">
                            <div class="add-type-form">
                                <input type="text" id="newDebtCategory" placeholder="New debt category" class="flex-1 border border-gray-300 rounded-lg px-3 py-2">
                                <button onclick="addCategory('debt')" class="notion-button">Add</button>
                            </div>
                            <div id="debtCategoryList" class="type-list"></div>
                        </div>

                        <!-- Savings Categories -->
                        <div id="savingsCategories" class="tab-content">
                            <div class="add-type-form">
                                <input type="text" id="newSavingsCategory" placeholder="New savings category" class="flex-1 border border-gray-300 rounded-lg px-3 py-2">
                                <button onclick="addCategory('savings')" class="notion-button">Add</button>
                            </div>
                            <div id="savingsCategoryList" class="type-list"></div>
                        </div>
                    </div>

                    <!-- Credit Cards Management -->
                    <div class="notion-card p-4">
                        <h3 class="text-lg font-semibold text-gray-900 mb-4 flex items-center">
                            <i class="fas fa-credit-card text-yellow-500 mr-2"></i>
                            <span data-translate="manageCreditCards">Manage Credit Cards</span>
                        </h3>
                        
                        <div class="space-y-4 mb-4">
                            <div class="grid grid-cols-2 gap-3">
                                <input type="text" id="newCardName" placeholder="Card name" class="border border-gray-300 rounded-lg px-3 py-2">
                                <select id="newCardCurrency" class="border border-gray-300 rounded-lg px-3 py-2">
                                    <option value="USD">USD</option>
                                    <option value="CRC">CRC</option>
                                </select>
                            </div>
                            <div class="grid grid-cols-2 gap-3">
                                <input type="number" id="newCardLimit" placeholder="Credit limit" step="0.01" class="border border-gray-300 rounded-lg px-3 py-2">
                                <input type="number" id="newCardInterest" placeholder="Interest rate %" step="0.01" class="border border-gray-300 rounded-lg px-3 py-2">
                            </div>
                            <button onclick="addCreditCard()" class="notion-button w-full">Add Credit Card</button>
                        </div>
                        
                        <div id="creditCardsList" class="type-list"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Bottom Navigation -->
    <div class="bottom-nav">
        <div class="flex justify-around">
            <button onclick="switchView('list')" id="navList" class="nav-item active">
                <i class="fas fa-list"></i>
                <span data-translate="listView">List</span>
            </button>
            <button onclick="switchView('graph')" id="navGraph" class="nav-item">
                <i class="fas fa-chart-bar"></i>
                <span data-translate="graphView">Charts</span>
            </button>
            <button onclick="switchView('types')" id="navTypes" class="nav-item">
                <i class="fas fa-cog"></i>
                <span data-translate="typesView">Types</span>
            </button>
            <button onclick="exportData()" class="nav-item">
                <i class="fas fa-download"></i>
                <span data-translate="export">Export</span>
            </button>
        </div>
    </div>

    <!-- Mobile Modal -->
    <div id="modal" class="mobile-modal">
        <div class="mobile-modal-header">
            <h3 id="modalTitle" class="text-lg font-semibold text-gray-900">Add Entry</h3>
            <button onclick="closeModal()" class="touch-target text-gray-500 hover:text-gray-300">
                <i class="fas fa-times text-lg"></i>
            </button>
        </div>
        <div class="mobile-modal-content">
            <form id="entryForm" class="space-y-6">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2" data-translate="description">Description</label>
                    <input type="text" id="description" required class="w-full border border-gray-300 rounded-lg px-4 py-3 text-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2" data-translate="amount">Amount</label>
                        <input type="number" id="amount" step="0.01" required class="w-full border border-gray-300 rounded-lg px-4 py-3 text-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2" data-translate="currency">Currency</label>
                        <select id="entryCurrency" class="w-full border border-gray-300 rounded-lg px-4 py-3 text-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="USD">USD</option>
                            <option value="CRC">CRC</option>
                        </select>
                    </div>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2" data-translate="category">Category</label>
                    <select id="category" required class="w-full border border-gray-300 rounded-lg px-4 py-3 text-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <!-- Options will be populated by JavaScript -->
                    </select>
                </div>
                
                <!-- Payment Method for Expenses -->
                <div id="paymentMethodField" class="hidden">
                    <label class="block text-sm font-medium text-gray-700 mb-2" data-translate="paymentMethod">Payment Method</label>
                    <select id="paymentMethod" onchange="toggleCreditCardField()" class="w-full border border-gray-300 rounded-lg px-4 py-3 text-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="cash">Cash</option>
                        <option value="debit">Debit Card</option>
                        <option value="credit">Credit Card</option>
                    </select>
                </div>

                <!-- Credit Card Selection -->
                <div id="creditCardField" class="hidden">
                    <label class="block text-sm font-medium text-gray-700 mb-2" data-translate="creditCard">Credit Card</label>
                    <select id="creditCardSelect" class="w-full border border-gray-300 rounded-lg px-4 py-3 text-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <!-- Options will be populated by JavaScript -->
                    </select>
                </div>

                <div id="targetAmountField" class="hidden">
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2" data-translate="targetAmount">Target Amount</label>
                            <input type="number" id="targetAmount" step="0.01" class="w-full border border-gray-300 rounded-lg px-4 py-3 text-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2" data-translate="targetCurrency">Target Currency</label>
                            <select id="targetCurrency" class="w-full border border-gray-300 rounded-lg px-4 py-3 text-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                                <option value="USD">USD</option>
                                <option value="CRC">CRC</option>
                            </select>
                        </div>
                    </div>
                </div>
                
                <!-- Debt Initial Total Field -->
                <div id="debtTotalField" class="hidden">
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2" data-translate="initialDebtTotal">Initial Debt Total</label>
                            <input type="number" id="initialDebtTotal" step="0.01" class="w-full border border-gray-300 rounded-lg px-4 py-3 text-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2" data-translate="interestRate">Interest Rate (%)</label>
                            <input type="number" id="interestRate" step="0.01" min="0" max="100" class="w-full border border-gray-300 rounded-lg px-4 py-3 text-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                    </div>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2" data-translate="date">Date</label>
                    <input type="date" id="date" required class="w-full border border-gray-300 rounded-lg px-4 py-3 text-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                <div class="flex space-x-4 pt-4">
                    <button type="submit" class="flex-1 notion-button py-4 text-lg" data-translate="addEntry">Add Entry</button>
                    <button type="button" onclick="closeModal()" class="flex-1 border border-gray-300 rounded-lg py-4 text-lg text-gray-700 hover:bg-gray-50" data-translate="cancel">Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Debt Contribution Modal -->
    <div id="contributionModal" class="mobile-modal">
        <div class="mobile-modal-header">
            <h3 id="contributionModalTitle" class="text-lg font-semibold text-gray-900">Make Payment</h3>
            <button onclick="closeContributionModal()" class="touch-target text-gray-500 hover:text-gray-300">
                <i class="fas fa-times text-lg"></i>
            </button>
        </div>
        <div class="mobile-modal-content">
            <form id="contributionForm" class="space-y-6">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2" data-translate="paymentAmount">Payment Amount</label>
                    <input type="number" id="contributionAmount" step="0.01" required class="w-full border border-gray-300 rounded-lg px-4 py-3 text-lg focus:outline-none focus:ring-2 focus:ring-blue-500" onchange="updatePaymentPreview()">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2" data-translate="paymentCurrency">Payment Currency</label>
                    <select id="contributionCurrency" onchange="updatePaymentPreview()" class="w-full border border-gray-300 rounded-lg px-4 py-3 text-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="USD">USD</option>
                        <option value="CRC">CRC</option>
                    </select>
                </div>
                <div id="paymentPreview" class="hidden p-3 bg-gray-600 rounded-lg">
                    <p class="text-sm text-gray-300">Payment in debt currency:</p>
                    <p class="font-bold" id="paymentPreviewAmount"></p>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2" data-translate="paymentDate">Payment Date</label>
                    <input type="date" id="contributionDate" required class="w-full border border-gray-300 rounded-lg px-4 py-3 text-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                <div class="flex space-x-4 pt-4">
                    <button type="submit" class="flex-1 contribution-button py-4 text-lg" data-translate="makePayment">Make Payment</button>
                    <button type="button" onclick="closeContributionModal()" class="flex-1 border border-gray-300 rounded-lg py-4 text-lg text-gray-700 hover:bg-gray-50" data-translate="cancel">Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Install Prompt -->
    <div id="installPrompt" class="install-prompt">
        <div class="flex-1">
            <h3 class="font-semibold">Install Budget Tracker</h3>
            <p class="text-sm text-blue-100">Add to your home screen for quick access!</p>
        </div>
        <div class="flex space-x-2">
            <button onclick="installApp()" class="bg-white text-blue-600 px-4 py-2 rounded-lg font-medium">Install</button>
            <button onclick="dismissInstallPrompt()" class="text-blue-100 px-2 py-2">
                <i class="fas fa-times"></i>
            </button>
        </div>
    </div>

    <script>
        // PWA Install functionality
        let deferredPrompt;
        let installPromptDismissed = localStorage.getItem('installPromptDismissed') === 'true';

        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            
            if (!installPromptDismissed) {
                setTimeout(() => {
                    document.getElementById('installPrompt').classList.add('show');
                }, 3000);
            }
        });

        function installApp() {
            if (deferredPrompt) {
                deferredPrompt.prompt();
                deferredPrompt.userChoice.then((choiceResult) => {
                    if (choiceResult.outcome === 'accepted') {
                        console.log('User accepted the install prompt');
                    }
                    deferredPrompt = null;
                    document.getElementById('installPrompt').classList.remove('show');
                });
            }
        }

        function dismissInstallPrompt() {
            document.getElementById('installPrompt').classList.remove('show');
            localStorage.setItem('installPromptDismissed', 'true');
        }

        // Generate manifest dynamically
        const manifest = {
            "name": "Budget Tracker",
            "short_name": "Budget",
            "start_url": "./",
            "display": "standalone",
            "background_color": "#111827",
            "theme_color": "#1f2937",
            "icons": [
                {
                    "src": "https://storage.googleapis.com/workspace-0f70711f-8b4e-4d94-86f1-2a93ccde5887/image/fa48675a-3ce0-4caa-a1bf-9aef225d05ff.png",
                    "sizes": "192x192",
                    "type": "image/png"
                },
                {
                    "src": "https://storage.googleapis.com/workspace-0f70711f-8b4e-4d94-86f1-2a93ccde5887/image/0a7c90ba-6a78-4ca1-98cd-66b34b4e8ca1.png", 
                    "sizes": "512x512",
                    "type": "image/png"
                }
            ]
        };

        const manifestBlob = new Blob([JSON.stringify(manifest)], {type: 'application/json'});
        const manifestURL = URL.createObjectURL(manifestBlob);
        document.getElementById('app-manifest').href = manifestURL;

        // Language translations
        const translations = {
            en: {
                title: "Budget Tracker",
                settings: "Settings",
                language: "Language",
                baseCurrency: "Base Currency",
                exchangeRate: "Exchange Rate (USD to CRC)",
                exchangeRateHelp: "1 USD = X CRC",
                listView: "List",
                graphView: "Charts",
                typesView: "Types",
                totalBalance: "Total Balance",
                totalDebt: "Total Debt",
                income: "Income",
                expenses: "Expenses",
                savings: "Savings",
                quickActions: "Quick Actions",
                addIncome: "Add Income",
                addExpense: "Add Expense",
                addDebt: "Add Debt",
                addSavings: "Add Savings",
                recentIncome: "Recent Income",
                recentExpenses: "Recent Expenses",
                debtTracking: "Debt Tracking",
                savingsGoals: "Savings Goals",
                noIncomeEntries: "No income entries yet",
                addFirstIncome: "Add your first income source",
                noExpensesRecorded: "No expenses recorded",
                trackSpending: "Track your spending",
                noDebtsTracked: "No debts tracked",
                monitorDebts: "Monitor your debts",
                noSavingsGoals: "No savings goals set",
                startSaving: "Start saving for your goals",
                incomeExpensesTrend: "Income vs Expenses Trend",
                expenseCategories: "Expense Categories",
                monthlyTotals: "Monthly Totals",
                debtProgress: "Debt Progress",
                description: "Description",
                amount: "Amount",
                currency: "Currency",
                category: "Category",
                targetAmount: "Target Amount",
                targetCurrency: "Target Currency",
                initialDebtTotal: "Initial Debt Total",
                interestRate: "Interest Rate",
                date: "Date",
                addEntry: "Add Entry",
                cancel: "Cancel",
                export: "Export",
                filterByMonth: "Filter by Month",
                allMonths: "All Months",
                clearFilter: "Clear",
                makePayment: "Make Payment",
                paymentAmount: "Payment Amount",
                paymentCurrency: "Payment Currency",
                paymentDate: "Payment Date",
                paymentMethod: "Payment Method",
                creditCard: "Credit Card",
                remaining: "Remaining",
                paidOff: "Paid Off",
                manageCategories: "Manage Categories",
                manageCreditCards: "Manage Credit Cards"
            },
            es: {
                title: "Control de Presupuesto",
                settings: "Configuración",
                language: "Idioma",
                baseCurrency: "Moneda Base",
                exchangeRate: "Tipo de Cambio (USD a CRC)",
                exchangeRateHelp: "1 USD = X CRC",
                listView: "Lista",
                graphView: "Gráficos",
                typesView: "Tipos",
                totalBalance: "Balance Total",
                totalDebt: "Deuda Total",
                income: "Ingresos",
                expenses: "Gastos",
                savings: "Ahorros",
                quickActions: "Acciones Rápidas",
                addIncome: "Agregar Ingreso",
                addExpense: "Agregar Gasto",
                addDebt: "Agregar Deuda",
                addSavings: "Agregar Ahorro",
                recentIncome: "Ingresos Recientes",
                recentExpenses: "Gastos Recientes",
                debtTracking: "Control de Deudas",
                savingsGoals: "Metas de Ahorro",
                noIncomeEntries: "Aún no hay ingresos",
                addFirstIncome: "Agrega tu primera fuente de ingresos",
                noExpensesRecorded: "No hay gastos registrados",
                trackSpending: "Rastrea tus gastos",
                noDebtsTracked: "No hay deudas registradas",
                monitorDebts: "Monitorea tus deudas",
                noSavingsGoals: "No hay metas de ahorro",
                startSaving: "Comienza a ahorrar para tus metas",
                incomeExpensesTrend: "Tendencia Ingresos vs Gastos",
                expenseCategories: "Categorías de Gastos",
                monthlyTotals: "Totales Mensuales",
                debtProgress: "Progreso de Deudas",
                description: "Descripción",
                amount: "Cantidad",
                currency: "Moneda",
                category: "Categoría",
                targetAmount: "Cantidad Objetivo",
                targetCurrency: "Moneda Objetivo",
                initialDebtTotal: "Total Inicial de Deuda",
                interestRate: "Tasa de Interés",
                date: "Fecha",
                addEntry: "Agregar Entrada",
                cancel: "Cancelar",
                export: "Exportar",
                filterByMonth: "Filtrar por Mes",
                allMonths: "Todos los Meses",
                clearFilter: "Limpiar",
                makePayment: "Hacer Pago",
                paymentAmount: "Cantidad de Pago",
                paymentCurrency: "Moneda de Pago",
                paymentDate: "Fecha de Pago",
                paymentMethod: "Método de Pago",
                creditCard: "Tarjeta de Crédito",
                remaining: "Restante",
                paidOff: "Pagado Completo",
                manageCategories: "Gestionar Categorías",
                manageCreditCards: "Gestionar Tarjetas de Crédito"
            }
        };

        // Default categories
        const defaultCategories = {
            income: ['Salary', 'Freelance', 'Investment', 'Business', 'Other'],
            expense: ['Food', 'Transportation', 'Housing', 'Entertainment', 'Health', 'Shopping', 'Utilities', 'Other'],
            debt: ['Credit Card', 'Student Loan', 'Mortgage', 'Personal Loan', 'Other'],
            savings: ['Emergency Fund', 'Vacation', 'House', 'Car', 'Retirement', 'Other']
        };

        // Data storage - THIS IS THE "DATABASE" stored in browser's localStorage
        let budgetData = {
            income: JSON.parse(localStorage.getItem('income')) || [],
            expenses: JSON.parse(localStorage.getItem('expenses')) || [],
            debt: JSON.parse(localStorage.getItem('debt')) || [],
            savings: JSON.parse(localStorage.getItem('savings')) || [],
            debtPayments: JSON.parse(localStorage.getItem('debtPayments')) || []
        };

        // Settings with dynamic categories
        let settings = {
            language: localStorage.getItem('language') || 'en',
            baseCurrency: localStorage.getItem('baseCurrency') || 'USD',
            exchangeRate: parseFloat(localStorage.getItem('exchangeRate')) || 520,
            categories: JSON.parse(localStorage.getItem('categories')) || defaultCategories,
            creditCards: JSON.parse(localStorage.getItem('creditCards')) || []
        };

        // Filter state
        let currentMonthFilter = 'all';
        let currentDebtId = null;
        let currentCategoryTab = 'income';

        // Chart instances
        let charts = {};
        let currentModalType = '';
        let currentView = 'list';

        // Helper function to map modal type to store key
        function storeKeyFor(type) {
            return type === 'expense' ? 'expenses' : type;
        }

        // Currency formatting
        function formatCurrency(amount, currency) {
            const symbols = { USD: '$', CRC: '₡' };
            const symbol = symbols[currency] || currency;
            return `${symbol}${amount.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
        }

        // Currency conversion
        function convertCurrency(amount, fromCurrency, toCurrency) {
            if (fromCurrency === toCurrency) return amount;
            
            if (fromCurrency === 'USD' && toCurrency === 'CRC') {
                return amount * settings.exchangeRate;
            } else if (fromCurrency === 'CRC' && toCurrency === 'USD') {
                return amount / settings.exchangeRate;
            }
            
            return amount;
        }

        // Get amount in base currency
        function getBaseAmount(amount, currency) {
            return convertCurrency(amount, currency, settings.baseCurrency);
        }

        // Get amount in secondary currency  
        function getSecondaryAmount(amount, currency) {
            const secondaryCurrency = settings.baseCurrency === 'USD' ? 'CRC' : 'USD';
            return convertCurrency(amount, currency, secondaryCurrency);
        }

        // Calculate remaining debt for a specific debt
        function getRemainingDebt(debtId) {
            const debt = budgetData.debt.find(d => d.id === debtId);
            if (!debt) return 0;

            const payments = budgetData.debtPayments.filter(p => p.debtId === debtId);
            const totalPayments = payments.reduce((sum, payment) => {
                // Convert payment to debt's currency for accurate calculation
                const paymentInDebtCurrency = convertCurrency(payment.amount, payment.currency, debt.currency);
                return sum + paymentInDebtCurrency;
            }, 0);

            const initialDebt = debt.initialTotal || debt.amount;
            return Math.max(0, initialDebt - totalPayments);
        }

        // Get debt summary by category
        function getDebtSummary() {
            const summary = {};
            
            budgetData.debt.forEach(debt => {
                if (!summary[debt.category]) {
                    summary[debt.category] = {
                        total: 0,
                        remaining: 0,
                        currency: debt.currency,
                        debts: []
                    };
                }
                
                const initialTotal = debt.initialTotal || debt.amount;
                const remaining = getRemainingDebt(debt.id);
                
                // Convert to base currency for summary totals
                const initialTotalBase = getBaseAmount(initialTotal, debt.currency);
                const remainingBase = getBaseAmount(remaining, debt.currency);
                
                summary[debt.category].total += initialTotalBase;
                summary[debt.category].remaining += remainingBase;
                summary[debt.category].debts.push({
                    ...debt,
                    remaining: remaining,
                    initialTotal: initialTotal
                });
            });
            
            return summary;
        }

        // Update payment preview in contribution modal
        function updatePaymentPreview() {
            const amount = parseFloat(document.getElementById('contributionAmount').value);
            const currency = document.getElementById('contributionCurrency').value;
            
            if (!amount || !currentDebtId) return;
            
            const debt = budgetData.debt.find(d => d.id === currentDebtId);
            if (!debt) return;
            
            const preview = document.getElementById('paymentPreview');
            const previewAmount = document.getElementById('paymentPreviewAmount');
            
            if (currency !== debt.currency) {
                const convertedAmount = convertCurrency(amount, currency, debt.currency);
                previewAmount.textContent = formatCurrency(convertedAmount, debt.currency);
                preview.classList.remove('hidden');
            } else {
                preview.classList.add('hidden');
            }
        }

        // Filter data by month
        function getFilteredData(data) {
            if (currentMonthFilter === 'all') return data;
            
            return data.filter(item => {
                const itemMonth = new Date(item.date).toLocaleDateString('en-US', { year: 'numeric', month: '2-digit' });
                return itemMonth === currentMonthFilter;
            });
        }

        // Populate month filter dropdown
        function populateMonthFilter() {
            const monthFilter = document.getElementById('monthFilter');
            const allDates = [
                ...budgetData.income.map(item => item.date),
                ...budgetData.expenses.map(item => item.date),
                ...budgetData.debt.map(item => item.date),
                ...budgetData.savings.map(item => item.date),
                ...budgetData.debtPayments.map(item => item.date)
            ];

            const uniqueMonths = [...new Set(allDates.map(date => {
                return new Date(date).toLocaleDateString('en-US', { year: 'numeric', month: '2-digit' });
            }))].sort().reverse();

            // Clear existing options except "All Months"
            const allMonthsOption = monthFilter.querySelector('option[value="all"]');
            monthFilter.innerHTML = '';
            monthFilter.appendChild(allMonthsOption);

            // Add month options
            uniqueMonths.forEach(month => {
                const option = document.createElement('option');
                option.value = month;
                const [year, monthNum] = month.split('/');
                const monthName = new Date(year, monthNum - 1, 1).toLocaleDateString('en-US', { year: 'numeric', month: 'long' });
                option.textContent = monthName;
                monthFilter.appendChild(option);
            });
        }

        // Filter by month
        function filterByMonth() {
            currentMonthFilter = document.getElementById('monthFilter').value;
            updateDashboard();
            renderAllLists();
            if (currentView === 'graph') {
                renderCharts();
            }
        }

        // Clear filter
        function clearFilter() {
            currentMonthFilter = 'all';
            document.getElementById('monthFilter').value = 'all';
            updateDashboard();
            renderAllLists();
            if (currentView === 'graph') {
                renderCharts();
            }
        }

        // Category management functions
        function switchCategoryTab(type) {
            currentCategoryTab = type;
            
            // Update tab buttons
            document.querySelectorAll('#typesView .settings-toggle button').forEach(btn => btn.classList.remove('active'));
            document.getElementById(`tab${type.charAt(0).toUpperCase() + type.slice(1)}`).classList.add('active');
            
            // Update tab content
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            document.getElementById(`${type}Categories`).classList.add('active');
            
            renderCategoryList(type);
        }

        function addCategory(type) {
            const input = document.getElementById(`new${type.charAt(0).toUpperCase() + type.slice(1)}Category`);
            const newCategory = input.value.trim();
            
            if (newCategory && !settings.categories[type].includes(newCategory)) {
                settings.categories[type].push(newCategory);
                localStorage.setItem('categories', JSON.stringify(settings.categories));
                input.value = '';
                renderCategoryList(type);
            }
        }

        function removeCategory(type, category) {
            settings.categories[type] = settings.categories[type].filter(cat => cat !== category);
            localStorage.setItem('categories', JSON.stringify(settings.categories));
            renderCategoryList(type);
        }

        function renderCategoryList(type) {
            const container = document.getElementById(`${type}CategoryList`);
            const categories = settings.categories[type];
            
            container.innerHTML = categories.map(category => `
                <div class="type-item">
                    <span class="text-gray-900">${category}</span>
                    <button onclick="removeCategory('${type}', '${category}')" class="text-red-500 hover:text-red-400">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            `).join('');
        }

        // Credit card management
        function addCreditCard() {
            const name = document.getElementById('newCardName').value.trim();
            const currency = document.getElementById('newCardCurrency').value;
            const limit = parseFloat(document.getElementById('newCardLimit').value) || 0;
            const interest = parseFloat(document.getElementById('newCardInterest').value) || 0;
            
            if (name) {
                const newCard = {
                    id: Date.now(),
                    name: name,
                    currency: currency,
                    limit: limit,
                    interestRate: interest
                };
                
                settings.creditCards.push(newCard);
                localStorage.setItem('creditCards', JSON.stringify(settings.creditCards));
                
                // Clear form
                document.getElementById('newCardName').value = '';
                document.getElementById('newCardLimit').value = '';
                document.getElementById('newCardInterest').value = '';
                
                renderCreditCardsList();
                populateCreditCardOptions();
            }
        }

        function removeCreditCard(cardId) {
            settings.creditCards = settings.creditCards.filter(card => card.id !== cardId);
            localStorage.setItem('creditCards', JSON.stringify(settings.creditCards));
            renderCreditCardsList();
            populateCreditCardOptions();
        }

        function renderCreditCardsList() {
            const container = document.getElementById('creditCardsList');
            
            if (settings.creditCards.length === 0) {
                container.innerHTML = `
                    <div class="text-center empty-state py-8">
                        <i class="fas fa-credit-card text-4xl mb-3"></i>
                        <p>No credit cards added</p>
                        <p class="text-sm">Add your first credit card</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = settings.creditCards.map(card => `
                <div class="type-item">
                    <div>
                        <div class="text-gray-900 font-medium">${card.name}</div>
                        <div class="text-sm text-gray-500">
                            ${card.currency} • Limit: ${formatCurrency(card.limit, card.currency)}
                            ${card.interestRate ? ` • ${card.interestRate}% APR` : ''}
                        </div>
                    </div>
                    <button onclick="removeCreditCard(${card.id})" class="text-red-500 hover:text-red-400">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            `).join('');
        }

        function populateCreditCardOptions() {
            const select = document.getElementById('creditCardSelect');
            select.innerHTML = settings.creditCards.map(card => 
                `<option value="${card.id}">${card.name} (${card.currency})</option>`
            ).join('');
        }

        function toggleCreditCardField() {
            const paymentMethod = document.getElementById('paymentMethod').value;
            const creditCardField = document.getElementById('creditCardField');
            
            if (paymentMethod === 'credit') {
                creditCardField.classList.remove('hidden');
                populateCreditCardOptions();
            } else {
                creditCardField.classList.add('hidden');
            }
        }

        // Open contribution modal
        function openContributionModal(debtId) {
            currentDebtId = debtId;
            const debt = budgetData.debt.find(d => d.id === debtId);
            
            document.getElementById('contributionModalTitle').textContent = 
                `${translations[settings.language].makePayment} - ${debt.description}`;
            document.getElementById('contributionDate').value = new Date().toISOString().split('T')[0];
            document.getElementById('contributionModal').classList.add('show');
            document.body.style.overflow = 'hidden';
        }

        // Close contribution modal
        function closeContributionModal() {
            document.getElementById('contributionModal').classList.remove('show');
            document.body.style.overflow = '';
            document.getElementById('contributionForm').reset();
            document.getElementById('paymentPreview').classList.add('hidden');
            currentDebtId = null;
        }

        // Handle contribution form submission
        document.getElementById('contributionForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            if (!currentDebtId) return;
            
            const payment = {
                id: Date.now(),
                debtId: currentDebtId,
                amount: parseFloat(document.getElementById('contributionAmount').value),
                currency: document.getElementById('contributionCurrency').value,
                date: document.getElementById('contributionDate').value,
                type: 'payment'
            };

            budgetData.debtPayments.push(payment);
            saveData('debtPayments', budgetData.debtPayments);
            
            // Add as expense
            const expense = {
                id: Date.now() + 1,
                description: `Debt Payment - ${budgetData.debt.find(d => d.id === currentDebtId).description}`,
                amount: payment.amount,
                currency: payment.currency,
                category: 'Debt Payment',
                date: payment.date,
                paymentMethod: 'debit'
            };
            
            budgetData.expenses.push(expense);
            saveData('expenses', budgetData.expenses);
            
            populateMonthFilter();
            updateDashboard();
            renderAllLists();
            
            if (currentView === 'graph') {
                renderCharts();
            }
            
            closeContributionModal();
        });

        // Initialize the app
        function init() {
            applyLanguage();
            updateCurrencyButtons();
            populateMonthFilter();
            updateDashboard();
            renderAllLists();
            renderAllCategoryLists();
            renderCreditCardsList();
            populateCreditCardOptions();
            
            // Prevent scroll bounce on iOS
            document.body.addEventListener('touchstart', function(e) {
                if (e.target === document.body) {
                    e.preventDefault();
                }
            }, { passive: false });
        }

        // Language functions
        function changeLanguage(lang) {
            settings.language = lang;
            localStorage.setItem('language', lang);
            
            document.getElementById('langEn').classList.toggle('active', lang === 'en');
            document.getElementById('langEs').classList.toggle('active', lang === 'es');
            
            applyLanguage();
            renderAllLists();
        }

        function applyLanguage() {
            const elements = document.querySelectorAll('[data-translate]');
            elements.forEach(element => {
                const key = element.getAttribute('data-translate');
                if (translations[settings.language][key]) {
                    element.textContent = translations[settings.language][key];
                }
            });
        }

        // Currency functions
        function changeBaseCurrency(currency) {
            settings.baseCurrency = currency;
            localStorage.setItem('baseCurrency', currency);
            updateCurrencyButtons();
            updateDashboard();
            renderAllLists();
        }

        function updateCurrencyButtons() {
            document.getElementById('currUSD').classList.toggle('active', settings.baseCurrency === 'USD');
            document.getElementById('currCRC').classList.toggle('active', settings.baseCurrency === 'CRC');
        }

        function updateExchangeRate() {
            const rate = parseFloat(document.getElementById('exchangeRate').value);
            if (rate > 0) {
                settings.exchangeRate = rate;
                localStorage.setItem('exchangeRate', rate);
                updateDashboard();
                renderAllLists();
            }
        }

        // Settings panel
        function toggleSettings() {
            const panel = document.getElementById('settingsPanel');
            panel.classList.toggle('hidden');
            
            // Update exchange rate input
            document.getElementById('exchangeRate').value = settings.exchangeRate;
        }

        // Close settings when clicking outside
        document.addEventListener('click', function(e) {
            const settingsPanel = document.getElementById('settingsPanel');
            const settingsButton = e.target.closest('button[onclick="toggleSettings()"]');
            
            if (!settingsPanel.contains(e.target) && !settingsButton && !settingsPanel.classList.contains('hidden')) {
                settingsPanel.classList.add('hidden');
            }
        });

        // Switch between views
        function switchView(view) {
            currentView = view;
            const listView = document.getElementById('listView');
            const graphView = document.getElementById('graphView');
            const typesView = document.getElementById('typesView');
            const navList = document.getElementById('navList');
            const navGraph = document.getElementById('navGraph');
            const navTypes = document.getElementById('navTypes');

            // Hide all views
            listView.classList.add('hidden');
            graphView.classList.add('hidden');
            typesView.classList.add('hidden');
            
            // Remove active from all nav items
            navList.classList.remove('active');
            navGraph.classList.remove('active');
            navTypes.classList.remove('active');

            if (view === 'list') {
                listView.classList.remove('hidden');
                navList.classList.add('active');
            } else if (view === 'graph') {
                graphView.classList.remove('hidden');
                navGraph.classList.add('active');
                
                // Render charts when switching to graph view
                setTimeout(() => {
                    renderCharts();
                }, 100);
            } else if (view === 'types') {
                typesView.classList.remove('hidden');
                navTypes.classList.add('active');
                renderAllCategoryLists();
                renderCreditCardsList();
            }
        }

        // Save data to localStorage
        function saveData(type, data) {
            localStorage.setItem(type, JSON.stringify(data));
        }

        // Open modal
        function openModal(type) {
            currentModalType = type;
            const modal = document.getElementById('modal');
            const title = document.getElementById('modalTitle');
            const categorySelect = document.getElementById('category');
            const targetAmountField = document.getElementById('targetAmountField');
            const debtTotalField = document.getElementById('debtTotalField');
            const paymentMethodField = document.getElementById('paymentMethodField');
            const dateInput = document.getElementById('date');

            // Set current date as default
            dateInput.value = new Date().toISOString().split('T')[0];

            // Update modal title
            const titleKey = `add${type.charAt(0).toUpperCase() + type.slice(1)}`;
            title.textContent = translations[settings.language][titleKey] || `Add ${type}`;

            // Populate category options from settings
            const categories = settings.categories[type];
            categorySelect.innerHTML = categories.map(cat => 
                `<option value="${cat}">${cat}</option>`
            ).join('');

            // Show/hide fields based on type
            if (type === 'savings') {
                targetAmountField.classList.remove('hidden');
                debtTotalField.classList.add('hidden');
                paymentMethodField.classList.add('hidden');
                document.getElementById('targetAmount').required = true;
            } else if (type === 'debt') {
                targetAmountField.classList.add('hidden');
                debtTotalField.classList.remove('hidden');
                paymentMethodField.classList.add('hidden');
                document.getElementById('initialDebtTotal').required = true;
            } else if (type === 'expense') {
                targetAmountField.classList.add('hidden');
                debtTotalField.classList.add('hidden');
                paymentMethodField.classList.remove('hidden');
                document.getElementById('targetAmount').required = false;
                document.getElementById('initialDebtTotal').required = false;
            } else {
                targetAmountField.classList.add('hidden');
                debtTotalField.classList.add('hidden');
                paymentMethodField.classList.add('hidden');
                document.getElementById('targetAmount').required = false;
                document.getElementById('initialDebtTotal').required = false;
            }

            modal.classList.add('show');
            document.body.style.overflow = 'hidden';
        }

        // Close modal
        function closeModal() {
            const modal = document.getElementById('modal');
            modal.classList.remove('show');
            document.body.style.overflow = '';
            document.getElementById('entryForm').reset();
            
            // Hide credit card field
            document.getElementById('creditCardField').classList.add('hidden');
        }

        // Handle form submission - FIXED BUG HERE
        document.getElementById('entryForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const entry = {
                id: Date.now(),
                description: document.getElementById('description').value,
                amount: parseFloat(document.getElementById('amount').value),
                currency: document.getElementById('entryCurrency').value,
                category: document.getElementById('category').value,
                date: document.getElementById('date').value
            };

            if (currentModalType === 'savings') {
                entry.targetAmount = parseFloat(document.getElementById('targetAmount').value);
                entry.targetCurrency = document.getElementById('targetCurrency').value;
            } else if (currentModalType === 'debt') {
                entry.initialTotal = parseFloat(document.getElementById('initialDebtTotal').value);
                entry.interestRate = parseFloat(document.getElementById('interestRate').value) || 0;
            } else if (currentModalType === 'expense') {
                entry.paymentMethod = document.getElementById('paymentMethod').value;
                
                // Handle credit card expenses
                if (entry.paymentMethod === 'credit') {
                    const cardId = parseInt(document.getElementById('creditCardSelect').value);
                    const card = settings.creditCards.find(c => c.id === cardId);
                    
                    if (card) {
                        entry.creditCardId = cardId;
                        
                        // Convert expense amount to card currency
                        const amountInCardCurrency = convertCurrency(entry.amount, entry.currency, card.currency);
                        
                        // Find or create debt for this credit card
                        let cardDebt = budgetData.debt.find(d => d.creditCardId === cardId);
                        
                        if (!cardDebt) {
                            // Create new debt for this card
                            cardDebt = {
                                id: Date.now() + 2,
                                description: card.name,
                                amount: amountInCardCurrency,
                                currency: card.currency,
                                category: 'Credit Card',
                                date: entry.date,
                                initialTotal: amountInCardCurrency,
                                interestRate: card.interestRate,
                                creditCardId: cardId
                            };
                            budgetData.debt.push(cardDebt);
                        } else {
                            // Update existing debt
                            cardDebt.initialTotal = (cardDebt.initialTotal || cardDebt.amount) + amountInCardCurrency;
                        }
                        
                        saveData('debt', budgetData.debt);
                    }
                }
            }

            // FIX: Use storeKey to map 'expense' to 'expenses'
            const storeKey = storeKeyFor(currentModalType);
            
            budgetData[storeKey].push(entry);
            saveData(storeKey, budgetData[storeKey]);
            
            populateMonthFilter();
            updateDashboard();
            renderList(storeKey);
            
            // Update charts if in graph view
            if (currentView === 'graph') {
                renderCharts();
            }
            
            closeModal();
        });

        // Update dashboard totals
        function updateDashboard() {
            const totals = {
                income: { base: 0, secondary: 0 },
                expenses: { base: 0, secondary: 0 },
                savings: { base: 0, secondary: 0 },
                debt: { base: 0, secondary: 0 }
            };

            // Calculate totals in both currencies using filtered data
            Object.keys(totals).forEach(type => {
                if (type === 'debt') {
                    // For debt, calculate remaining debt amounts
                    budgetData.debt.forEach(debt => {
                        const remaining = getRemainingDebt(debt.id);
                        const remainingBase = getBaseAmount(remaining, debt.currency);
                        const remainingSecondary = getSecondaryAmount(remaining, debt.currency);
                        
                        totals.debt.base += remainingBase;
                        totals.debt.secondary += remainingSecondary;
                    });
                } else {
                    const filteredData = getFilteredData(budgetData[type]);
                    filteredData.forEach(item => {
                        const baseAmount = getBaseAmount(item.amount, item.currency);
                        const secondaryAmount = getSecondaryAmount(item.amount, item.currency);
                        
                        totals[type].base += baseAmount;
                        totals[type].secondary += secondaryAmount;
                    });
                }
            });

            const totalBalance = totals.income.base - totals.expenses.base - totals.debt.base + totals.savings.base;
            const totalBalanceSecondary = totals.income.secondary - totals.expenses.secondary - totals.debt.secondary + totals.savings.secondary;
            
            const secondaryCurrency = settings.baseCurrency === 'USD' ? 'CRC' : 'USD';

            // Update display
            document.getElementById('totalBalance').textContent = formatCurrency(totalBalance, settings.baseCurrency);
            document.getElementById('totalBalanceSecondary').textContent = formatCurrency(totalBalanceSecondary, secondaryCurrency);
            
            document.getElementById('totalIncome').textContent = formatCurrency(totals.income.base, settings.baseCurrency);
            document.getElementById('totalIncomeSecondary').textContent = formatCurrency(totals.income.secondary, secondaryCurrency);
            
            document.getElementById('totalExpenses').textContent = formatCurrency(totals.expenses.base, settings.baseCurrency);
            document.getElementById('totalExpensesSecondary').textContent = formatCurrency(totals.expenses.secondary, secondaryCurrency);
            
            document.getElementById('totalDebt').textContent = formatCurrency(totals.debt.base, settings.baseCurrency);
            document.getElementById('totalDebtSecondary').textContent = formatCurrency(totals.debt.secondary, secondaryCurrency);
        }

        // Render debt summary
        function renderDebtSummary() {
            const container = document.getElementById('debtSummary');
            const summary = getDebtSummary();
            const categories = Object.keys(summary);

            if (categories.length === 0) {
                container.innerHTML = '';
                return;
            }

            container.innerHTML = categories.map(category => {
                const data = summary[category];
                const progress = data.total > 0 ? ((data.total - data.remaining) / data.total) * 100 : 0;
                
                return `
                    <div class="debt-summary-card">
                        <div class="flex justify-between items-start mb-2">
                            <h4 class="font-medium text-gray-900">${category}</h4>
                            <span class="currency-badge">${settings.baseCurrency}</span>
                        </div>
                        <div class="mb-2">
                            <div class="flex justify-between text-sm mb-1">
                                <span>${formatCurrency(data.total - data.remaining, settings.baseCurrency)} paid of ${formatCurrency(data.total, settings.baseCurrency)}</span>
                                <span>${progress.toFixed(1)}%</span>
                            </div>
                            <div class="w-full bg-gray-600 rounded-full h-2">
                                <div class="debt-progress-bar" style="width: ${progress}%"></div>
                            </div>
                        </div>
                        <div class="text-sm text-gray-500">
                            ${translations[settings.language].remaining}: ${formatCurrency(data.remaining, settings.baseCurrency)}
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Render all category lists
        function renderAllCategoryLists() {
            ['income', 'expense', 'debt', 'savings'].forEach(type => {
                renderCategoryList(type);
            });
        }

        // Render all lists
        function renderAllLists() {
            renderList('income');
            renderList('expenses');
            renderList('debt');
            renderList('savings');
            renderDebtSummary();
        }

        // Render individual list
        function renderList(type) {
            const container = document.getElementById(`${type}List`);
            if (!container) {
                console.error(`Container not found for type: ${type}`);
                return;
            }
            
            const data = getFilteredData(budgetData[type]);

            if (data.length === 0) {
                const emptyStateKeys = {
                    income: { text: 'noIncomeEntries', subtext: 'addFirstIncome' },
                    expenses: { text: 'noExpensesRecorded', subtext: 'trackSpending' },
                    debt: { text: 'noDebtsTracked', subtext: 'monitorDebts' },
                    savings: { text: 'noSavingsGoals', subtext: 'startSaving' }
                };
                
                const icons = {
                    income: 'fas fa-wallet',
                    expenses: 'fas fa-shopping-cart', 
                    debt: 'fas fa-handshake',
                    savings: 'fas fa-target'
                };
                
                const empty = emptyStateKeys[type];
                container.innerHTML = `
                    <div class="text-center empty-state py-8">
                        <i class="${icons[type]} text-4xl mb-3"></i>
                        <p>${translations[settings.language][empty.text]}</p>
                        <p class="text-sm">${translations[settings.language][empty.subtext]}</p>
                    </div>
                `;
                return;
            }

            // Sort by date (newest first)
            const sortedData = [...data].sort((a, b) => new Date(b.date) - new Date(a.date));
            
            if (type === 'savings') {
                container.innerHTML = sortedData.map(item => {
                    const targetInSameCurrency = item.targetCurrency ? 
                        convertCurrency(item.targetAmount, item.targetCurrency, item.currency) : 
                        item.targetAmount;
                    
                    const progress = Math.min((item.amount / targetInSameCurrency) * 100, 100);
                    const secondaryAmount = getSecondaryAmount(item.amount, item.currency);
                    const secondaryCurrency = settings.baseCurrency === 'USD' ? 'CRC' : 'USD';
                    
                    return `
                        <div class="savings-item p-4 border border-gray-200 rounded-lg">
                            <div class="flex justify-between items-start mb-2">
                                <div class="flex-1">
                                    <h4 class="font-medium text-gray-900">${item.description}</h4>
                                    <p class="text-sm text-gray-500">${item.category}</p>
                                    ${item.currency !== secondaryCurrency ? `<p class="secondary-amount">${formatCurrency(secondaryAmount, secondaryCurrency)}</p>` : ''}
                                </div>
                                <div class="flex items-center space-x-2">
                                    <span class="currency-badge">${item.currency}</span>
                                    <button onclick="deleteEntry('${type}', ${item.id})" class="touch-target text-red-500 hover:text-red-400">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </div>
                            <div class="mb-2">
                                <div class="flex justify-between text-sm mb-1">
                                    <span>${formatCurrency(item.amount, item.currency)} of ${formatCurrency(item.targetAmount, item.targetCurrency || item.currency)}</span>
                                    <span>${progress.toFixed(1)}%</span>
                                </div>
                                <div class="w-full bg-gray-600 rounded-full h-2">
                                    <div class="progress-bar" style="width: ${progress}%"></div>
                                </div>
                            </div>
                            <p class="text-xs text-gray-500">${new Date(item.date).toLocaleDateString()}</p>
                        </div>
                    `;
                }).join('');
            } else if (type === 'debt') {
                container.innerHTML = sortedData.map(item => {
                    const remaining = getRemainingDebt(item.id);
                    const initialTotal = item.initialTotal || item.amount;
                    const progress = initialTotal > 0 ? ((initialTotal - remaining) / initialTotal) * 100 : 0;
                    const isPaidOff = remaining <= 0;
                    const secondaryAmount = getSecondaryAmount(remaining, item.currency);
                    const secondaryCurrency = item.currency === 'USD' ? 'CRC' : 'USD';
                    
                    return `
                        <div class="debt-item p-4 border border-gray-200 rounded-lg ${isPaidOff ? 'opacity-60' : ''}">
                            <div class="flex justify-between items-start mb-2">
                                <div class="flex-1">
                                    <h4 class="font-medium text-gray-900">${item.description} ${isPaidOff ? '(' + translations[settings.language].paidOff + ')' : ''}</h4>
                                    <p class="text-sm text-gray-500">${item.category}</p>
                                    <div class="mt-2">
                                        <div class="flex justify-between text-sm mb-1">
                                            <div>
                                                <span>${translations[settings.language].remaining}: ${formatCurrency(remaining, item.currency)}</span>
                                                ${item.currency !== secondaryCurrency ? `<p class="secondary-amount">${formatCurrency(secondaryAmount, secondaryCurrency)}</p>` : ''}
                                            </div>
                                            <span>${progress.toFixed(1)}% paid</span>
                                        </div>
                                        <div class="w-full bg-gray-600 rounded-full h-2">
                                            <div class="debt-progress-bar" style="width: ${progress}%"></div>
                                        </div>
                                    </div>
                                </div>
                                <div class="flex flex-col items-end space-y-2">
                                    <span class="currency-badge">${item.currency}</span>
                                    <div class="flex space-x-2">
                                        ${!isPaidOff ? `<button onclick="openContributionModal(${item.id})" class="contribution-button text-xs px-2 py-1">Pay</button>` : ''}
                                        <button onclick="deleteEntry('${type}', ${item.id})" class="touch-target text-red-500 hover:text-red-400">
                                            <i class="fas fa-trash text-sm"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                            <div class="text-xs text-gray-500">
                                <p>Initial: ${formatCurrency(initialTotal, item.currency)} • ${new Date(item.date).toLocaleDateString()}</p>
                                ${item.interestRate ? `<p>Interest Rate: ${item.interestRate}%</p>` : ''}
                            </div>
                        </div>
                    `;
                }).join('');
            } else {
                const colorClass = type === 'income' ? 'text-green-500' : 'text-red-500';
                const itemClass = type === 'income' ? 'income-item' : 'expense-item';
                
                container.innerHTML = sortedData.map(item => {
                    const secondaryAmount = getSecondaryAmount(item.amount, item.currency);
                    const secondaryCurrency = item.currency === 'USD' ? 'CRC' : 'USD';
                    const paymentMethodIcons = { credit: '💳', debit: '🏦', cash: '💵' };
                    const paymentIcon = paymentMethodIcons[item.paymentMethod] || '';
                    
                    return `
                        <div class="${itemClass} flex justify-between items-center p-3 border border-gray-200 rounded-lg">
                            <div class="flex-1">
                                <h4 class="font-medium text-gray-900">${item.description}</h4>
                                <p class="text-sm text-gray-500">
                                    ${item.category} • ${new Date(item.date).toLocaleDateString()}
                                    ${paymentIcon ? ` • ${paymentIcon}` : ''}
                                </p>
                                ${item.currency !== secondaryCurrency ? `<p class="secondary-amount">${formatCurrency(secondaryAmount, secondaryCurrency)}</p>` : ''}
                            </div>
                            <div class="flex items-center space-x-2">
                                <div class="text-right">
                                    <span class="font-bold ${colorClass}">${formatCurrency(item.amount, item.currency)}</span>
                                </div>
                                <span class="currency-badge">${item.currency}</span>
                                <button onclick="deleteEntry('${type}', ${item.id})" class="touch-target text-red-500 hover:text-red-400">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                    `;
                }).join('');
            }
        }

        // Delete entry
        function deleteEntry(type, id) {
            const confirmMessage = settings.language === 'es' ? 
                '¿Estás seguro de que quieres eliminar esta entrada?' : 
                'Are you sure you want to delete this entry?';
                
            if (confirm(confirmMessage)) {
                budgetData[type] = budgetData[type].filter(item => item.id !== id);
                
                // If deleting a debt, also remove associated payments
                if (type === 'debt') {
                    budgetData.debtPayments = budgetData.debtPayments.filter(payment => payment.debtId !== id);
                    saveData('debtPayments', budgetData.debtPayments);
                }
                
                saveData(type, budgetData[type]);
                populateMonthFilter();
                updateDashboard();
                renderList(type);
                renderDebtSummary();
                
                // Update charts if in graph view
                if (currentView === 'graph') {
                    renderCharts();
                }
            }
        }

        // Export data functionality
        function exportData() {
            const dataToExport = {
                ...budgetData,
                settings,
                exportDate: new Date().toISOString()
            };
            
            const dataStr = JSON.stringify(dataToExport, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            
            const link = document.createElement('a');
            link.href = URL.createObjectURL(dataBlob);
            link.download = `budget-tracker-${new Date().toISOString().split('T')[0]}.json`;
            link.click();
        }

        // Render all charts
        function renderCharts() {
            renderIncomeExpenseChart();
            renderExpenseCategoryChart();
            renderMonthlyTotalsChart();
            renderDebtProgressChart();
        }

        // Income vs Expenses trend chart
        function renderIncomeExpenseChart() {
            const ctx = document.getElementById('incomeExpenseChart').getContext('2d');
            
            if (charts.incomeExpense) {
                charts.incomeExpense.destroy();
            }

            // Group data by month (convert all to base currency)
            const monthlyData = {};
            const filteredIncome = getFilteredData(budgetData.income);
            const filteredExpenses = getFilteredData(budgetData.expenses);
            
            [...filteredIncome, ...filteredExpenses].forEach(item => {
                const month = new Date(item.date).toLocaleDateString('en-US', { year: 'numeric', month: 'short' });
                if (!monthlyData[month]) {
                    monthlyData[month] = { income: 0, expenses: 0 };
                }
                
                const baseAmount = getBaseAmount(item.amount, item.currency);
                
                if (filteredIncome.includes(item)) {
                    monthlyData[month].income += baseAmount;
                } else {
                    monthlyData[month].expenses += baseAmount;
                }
            });

            const months = Object.keys(monthlyData).sort();
            const incomeData = months.map(month => monthlyData[month].income);
            const expenseData = months.map(month => monthlyData[month].expenses);

            const labels = {
                en: { income: 'Income', expenses: 'Expenses' },
                es: { income: 'Ingresos', expenses: 'Gastos' }
            };

            charts.incomeExpense = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: months,
                    datasets: [{
                        label: labels[settings.language].income,
                        data: incomeData,
                        borderColor: '#10b981',
                        backgroundColor: 'rgba(16, 185, 129, 0.1)',
                        tension: 0.4,
                        pointRadius: 4,
                        pointHoverRadius: 6
                    }, {
                        label: labels[settings.language].expenses,
                        data: expenseData,
                        borderColor: '#ef4444',
                        backgroundColor: 'rgba(239, 68, 68, 0.1)',
                        tension: 0.4,
                        pointRadius: 4,
                        pointHoverRadius: 6
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'top',
                            labels: {
                                color: '#f9fafb'
                            }
                        }
                    },
                    scales: {
                        x: {
                            ticks: {
                                color: '#9ca3af'
                            },
                            grid: {
                                color: '#374151'
                            }
                        },
                        y: {
                            beginAtZero: true,
                            ticks: {
                                color: '#9ca3af',
                                callback: function(value) {
                                    return formatCurrency(value, settings.baseCurrency);
                                }
                            },
                            grid: {
                                color: '#374151'
                            }
                        }
                    }
                }
            });
        }

        // Expense categories pie chart
        function renderExpenseCategoryChart() {
            const ctx = document.getElementById('expenseCategoryChart').getContext('2d');
            
            if (charts.expenseCategory) {
                charts.expenseCategory.destroy();
            }

            // Group expenses by category (convert all to base currency)
            const categoryData = {};
            const filteredExpenses = getFilteredData(budgetData.expenses);
            filteredExpenses.forEach(item => {
                const baseAmount = getBaseAmount(item.amount, item.currency);
                categoryData[item.category] = (categoryData[item.category] || 0) + baseAmount;
            });

            const labels = Object.keys(categoryData);
            const data = Object.values(categoryData);
            const colors = [
                '#ef4444', '#f59e0b', '#10b981', '#3b82f6',
                '#8b5cf6', '#f97316', '#06b6d4', '#84cc16'
            ];

            charts.expenseCategory = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: labels,
                    datasets: [{
                        data: data,
                        backgroundColor: colors.slice(0, labels.length)
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                color: '#f9fafb'
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const percentage = ((context.raw / total) * 100).toFixed(1);
                                    return context.label + ': ' + formatCurrency(context.raw, settings.baseCurrency) + ' (' + percentage + '%)';
                                }
                            }
                        }
                    }
                }
            });
        }

        // Monthly totals bar chart
        function renderMonthlyTotalsChart() {
            const ctx = document.getElementById('monthlyTotalsChart').getContext('2d');
            
            if (charts.monthlyTotals) {
                charts.monthlyTotals.destroy();
            }

            // Group data by month (convert all to base currency)
            const monthlyData = {};
            const filteredIncome = getFilteredData(budgetData.income);
            const filteredExpenses = getFilteredData(budgetData.expenses);
            const filteredSavings = getFilteredData(budgetData.savings);
            
            [...filteredIncome, ...filteredExpenses, ...filteredSavings].forEach(item => {
                const month = new Date(item.date).toLocaleDateString('en-US', { year: 'numeric', month: 'short' });
                if (!monthlyData[month]) {
                    monthlyData[month] = { income: 0, expenses: 0, savings: 0 };
                }
                
                const baseAmount = getBaseAmount(item.amount, item.currency);
                
                if (filteredIncome.includes(item)) {
                    monthlyData[month].income += baseAmount;
                } else if (filteredExpenses.includes(item)) {
                    monthlyData[month].expenses += baseAmount;
                } else if (filteredSavings.includes(item)) {
                    monthlyData[month].savings += baseAmount;
                }
            });

            const months = Object.keys(monthlyData).sort();
            const incomeData = months.map(month => monthlyData[month].income);
            const expenseData = months.map(month => monthlyData[month].expenses);
            const savingsData = months.map(month => monthlyData[month].savings);

            const labels = {
                en: { income: 'Income', expenses: 'Expenses', savings: 'Savings' },
                es: { income: 'Ingresos', expenses: 'Gastos', savings: 'Ahorros' }
            };

            charts.monthlyTotals = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: months,
                    datasets: [{
                        label: labels[settings.language].income,
                        data: incomeData,
                        backgroundColor: '#10b981'
                    }, {
                        label: labels[settings.language].expenses,
                        data: expenseData,
                        backgroundColor: '#ef4444'
                    }, {
                        label: labels[settings.language].savings,
                        data: savingsData,
                        backgroundColor: '#8b5cf6'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'top',
                            labels: {
                                color: '#f9fafb'
                            }
                        }
                    },
                    scales: {
                        x: {
                            ticks: {
                                color: '#9ca3af'
                            },
                            grid: {
                                color: '#374151'
                            }
                        },
                        y: {
                            beginAtZero: true,
                            ticks: {
                                color: '#9ca3af',
                                callback: function(value) {
                                    return formatCurrency(value, settings.baseCurrency);
                                }
                            },
                            grid: {
                                color: '#374151'
                            }
                        }
                    }
                }
            });
        }

        // Debt progress chart
        function renderDebtProgressChart() {
            const ctx = document.getElementById('debtProgressChart').getContext('2d');
            
            if (charts.debtProgress) {
                charts.debtProgress.destroy();
            }

            const debtSummary = getDebtSummary();
            const categories = Object.keys(debtSummary);
            
            if (categories.length === 0) {
                ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height);
                return;
            }

            const totalAmounts = categories.map(cat => debtSummary[cat].total);
            const remainingAmounts = categories.map(cat => debtSummary[cat].remaining);
            const paidAmounts = categories.map(cat => debtSummary[cat].total - debtSummary[cat].remaining);

            const chartLabels = {
                en: { remaining: 'Remaining', paid: 'Paid' },
                es: { remaining: 'Restante', paid: 'Pagado' }
            };

            charts.debtProgress = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: categories,
                    datasets: [{
                        label: chartLabels[settings.language].paid,
                        data: paidAmounts,
                        backgroundColor: '#10b981'
                    }, {
                        label: chartLabels[settings.language].remaining,
                        data: remainingAmounts,
                        backgroundColor: '#f59e0b'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'top',
                            labels: {
                                color: '#f9fafb'
                            }
                        }
                    },
                    scales: {
                        x: {
                            stacked: true,
                            ticks: {
                                color: '#9ca3af'
                            },
                            grid: {
                                color: '#374151'
                            }
                        },
                        y: {
                            stacked: true,
                            beginAtZero: true,
                            ticks: {
                                color: '#9ca3af',
                                callback: function(value) {
                                    return formatCurrency(value, settings.baseCurrency);
                                }
                            },
                            grid: {
                                color: '#374151'
                            }
                        }
                    }
                }
            });
        }

        // Initialize the app when page loads
        document.addEventListener('DOMContentLoaded', init);

        // Service Worker Registration
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', function() {
                navigator.serviceWorker.register(URL.createObjectURL(new Blob([`
                    const CACHE_NAME = 'budget-tracker-v1';
                    const urlsToCache = [
                        './',
                        'https://cdn.tailwindcss.com',
                        'https://cdn.jsdelivr.net/npm/chart.js',
                        'https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css'
                    ];

                    self.addEventListener('install', function(event) {
                        event.waitUntil(
                            caches.open(CACHE_NAME)
                                .then(function(cache) {
                                    return cache.addAll(urlsToCache);
                                })
                        );
                    });

                    self.addEventListener('fetch', function(event) {
                        event.respondWith(
                            caches.match(event.request)
                                .then(function(response) {
                                    if (response) {
                                        return response;
                                    }
                                    return fetch(event.request);
                                })
                        );
                    });
                `], { type: 'application/javascript' })))
                .then(function(registration) {
                    console.log('ServiceWorker registration successful');
                }, function(err) {
                    console.log('ServiceWorker registration failed: ', err);
                });
            });
        }
    </script>
</body>
</html>

